{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/Meir017/ado-pr-review-needed/main/pr-review-config.schema.json",
  "title": "PR Review Needed Configuration",
  "description": "Configuration file for the pr-review-needed tool, which generates a markdown summary of Azure DevOps pull requests that need review.",
  "type": "object",
  "required": ["repositories"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "The JSON schema reference for this configuration file."
    },
    "repositories": {
      "type": "array",
      "description": "List of Azure DevOps Git repositories to monitor for open pull requests.",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["url"],
        "additionalProperties": false,
        "properties": {
          "url": {
            "type": "string",
            "description": "The full Azure DevOps repository URL in the format https://dev.azure.com/{org}/{project}/_git/{repo}.",
            "pattern": "^https://dev\\.azure\\.com/.+/.+/_git/.+$",
            "examples": ["https://dev.azure.com/myorg/myproject/_git/myrepo"]
          },
          "skipRestartMerge": {
            "type": "boolean",
            "description": "When true, skip automatically restarting merge for stale pull requests in this repository. Defaults to false.",
            "default": false
          },
          "patterns": {
            "type": "object",
            "description": "File pattern matching configuration for this repository. Used to ignore generated files and auto-label PRs based on changed files.",
            "additionalProperties": false,
            "properties": {
              "ignore": {
                "type": "array",
                "description": "List of glob patterns for files to ignore during review. These typically represent generated files that should not be reviewed. Ignored files are excluded from size calculations and label matching.",
                "items": {
                  "type": "string",
                  "description": "A glob pattern such as '**/*.generated.cs' or '**/*.designer.cs'."
                },
                "default": []
              },
              "labels": {
                "type": "object",
                "description": "A mapping of label names to glob patterns. When non-ignored changed files in a PR match the patterns, the label is applied to the PR.",
                "additionalProperties": {
                  "type": "array",
                  "description": "List of glob patterns. If any non-ignored changed file matches, the label (the key) is applied.",
                  "items": {
                    "type": "string",
                    "description": "A glob pattern such as '**/azure-pipelines*.yml' or '**/Dockerfile'."
                  },
                  "minItems": 1
                },
                "default": {}
              }
            }
          }
        }
      }
    },
    "teamMembers": {
      "type": "array",
      "description": "List of team member email addresses (or ADO unique names) whose pull requests should be tracked. These are used to distinguish team PRs from external ones.",
      "items": {
        "type": "string",
        "description": "An email address or ADO unique name identifying a team member.",
        "examples": ["alice@example.com", "bob@example.com"]
      },
      "default": []
    },
    "manager": {
      "type": ["string", "null"],
      "description": "Email address of a direct manager. When provided, the tool will automatically fetch that manager's direct reports from Microsoft Graph and add them to the team members list.",
      "examples": ["manager@example.com"]
    },
    "orgManager": {
      "type": ["string", "null"],
      "description": "Email address of an org-level manager. When provided, the tool will recursively fetch all members of that manager's organization from Microsoft Graph and add them to the team members list.",
      "examples": ["orgmanager@example.com"]
    },
    "ignoreManagers": {
      "type": "boolean",
      "description": "When true, managers resolved via 'manager' or 'orgManager' are added to the ignored-users list and excluded from review-needed calculations. Useful for excluding managers who rarely review PRs. Defaults to false.",
      "default": false
    },
    "botUsers": {
      "type": "array",
      "description": "List of bot or service-account email addresses or display names to exclude from reviewer and author calculations entirely.",
      "items": {
        "type": "string",
        "description": "An email address, ADO unique name, or display name identifying a bot or service account.",
        "examples": ["ci-bot@example.com"]
      },
      "default": []
    },
    "aiBotUsers": {
      "type": "array",
      "description": "List of AI bot email addresses or display names. Their activity is filtered like bots, but their PRs still require human review (action stays REVIEW instead of APPROVE).",
      "items": {
        "type": "string",
        "description": "An email address, ADO unique name, or display name identifying an AI bot account.",
        "examples": ["copilot-bot@example.com"]
      },
      "default": []
    },
    "quantifier": {
      "type": "object",
      "description": "Configuration for the PR size quantifier, which labels pull requests by the total number of changed lines.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether to compute and display PR size labels. Defaults to true.",
          "default": true
        },
        "excludedPatterns": {
          "type": "array",
          "description": "List of glob patterns for files whose line changes should be excluded from the size calculation (e.g. generated files, lock files).",
          "items": {
            "type": "string",
            "description": "A glob pattern such as '**/*.generated.cs' or 'package-lock.json'."
          },
          "default": []
        },
        "thresholds": {
          "type": "array",
          "description": "Ordered list of size thresholds that map a maximum number of changed lines to a label. The first threshold whose maxChanges is greater than or equal to the PR's total changes is used. If the PR exceeds all thresholds it receives the last label.",
          "items": {
            "type": "object",
            "required": ["label", "maxChanges"],
            "additionalProperties": false,
            "properties": {
              "label": {
                "type": "string",
                "description": "The human-readable size label assigned when the PR falls within this threshold.",
                "enum": ["XS", "S", "M", "L", "XL"],
                "examples": ["XS", "S", "M", "L", "XL"]
              },
              "maxChanges": {
                "type": "integer",
                "description": "The maximum total number of changed lines (additions + deletions) that maps to this label.",
                "minimum": 1,
                "examples": [10, 40, 100, 400, 1000]
              }
            }
          },
          "default": [
            { "label": "XS", "maxChanges": 10 },
            { "label": "S", "maxChanges": 40 },
            { "label": "M", "maxChanges": 100 },
            { "label": "L", "maxChanges": 400 },
            { "label": "XL", "maxChanges": 1000 }
          ]
        }
      }
    },
    "restartMergeAfterDays": {
      "type": "integer",
      "description": "Number of days after which a pull request with a stale merge status will have its merge automatically restarted. Set to a negative value to disable auto-restart globally. Defaults to 30.",
      "default": 30,
      "examples": [30, 7, -1]
    },
    "staleness": {
      "type": "object",
      "description": "Configuration for PR staleness/aging alerts. When enabled, PRs are tagged with staleness badges based on how long they have been waiting.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether to compute and display staleness badges. Defaults to true.",
          "default": true
        },
        "thresholds": {
          "type": "array",
          "description": "Ordered list of staleness thresholds. Each threshold defines a minimum number of days and a label. The highest matching threshold (by minDays) is applied.",
          "items": {
            "type": "object",
            "required": ["label", "minDays"],
            "additionalProperties": false,
            "properties": {
              "label": {
                "type": "string",
                "description": "The badge label to display when a PR exceeds this threshold.",
                "examples": ["‚ö†Ô∏è Aging", "üî¥ Stale", "üíÄ Abandoned"]
              },
              "minDays": {
                "type": "integer",
                "description": "Minimum number of days a PR must be waiting to receive this badge.",
                "minimum": 1,
                "examples": [7, 14, 30]
              }
            }
          },
          "default": [
            { "label": "‚ö†Ô∏è Aging", "minDays": 7 },
            { "label": "üî¥ Stale", "minDays": 14 },
            { "label": "üíÄ Abandoned", "minDays": 30 }
          ]
        }
      }
    },
    "notifications": {
      "type": "object",
      "description": "Configuration for push notifications via Microsoft Teams incoming webhooks.",
      "additionalProperties": false,
      "properties": {
        "teams": {
          "type": "object",
          "description": "Microsoft Teams incoming webhook configuration.",
          "required": ["webhookUrl"],
          "additionalProperties": false,
          "properties": {
            "webhookUrl": {
              "type": "string",
              "description": "The Teams incoming webhook URL.",
              "format": "uri",
              "examples": ["https://outlook.office.com/webhook/..."]
            },
            "filters": {
              "type": "object",
              "description": "Control which sections to include in the notification.",
              "additionalProperties": false,
              "properties": {
                "sections": {
                  "type": "array",
                  "description": "Which PR sections to include. Defaults to all sections.",
                  "items": {
                    "type": "string",
                    "enum": ["approved", "needingReview", "waitingOnAuthor"]
                  }
                },
                "minStalenessLevel": {
                  "type": "string",
                  "description": "Only include PRs at or above this staleness level."
                }
              }
            }
          }
        }
      }
    },
    "webhook": {
      "type": "object",
      "description": "Configuration for sending the full JSON report to an external webhook endpoint (e.g. Grafana, Power BI).",
      "additionalProperties": false,
      "required": ["url"],
      "properties": {
        "url": {
          "type": "string",
          "description": "The webhook URL to POST the JSON report to.",
          "format": "uri",
          "examples": ["https://my-grafana/api/push"]
        },
        "headers": {
          "type": "object",
          "description": "Additional HTTP headers to include in the webhook request.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "method": {
          "type": "string",
          "description": "HTTP method for the webhook request. Defaults to POST.",
          "enum": ["POST", "PUT"],
          "default": "POST"
        }
      }
    },
    "autoNudge": {
      "type": "object",
      "description": "Configuration for automatically posting reminder comments on stale PRs that need review.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether to enable auto-nudge comments. Defaults to false.",
          "default": false
        },
        "minStalenessLevel": {
          "type": "string",
          "description": "Only nudge PRs at or above this staleness level. Must match a label from staleness thresholds.",
          "examples": ["üî¥ Stale", "üíÄ Abandoned"]
        },
        "cooldownDays": {
          "type": "integer",
          "description": "Minimum number of days between nudges for the same PR. Defaults to 7.",
          "default": 7,
          "minimum": 1
        },
        "commentTemplate": {
          "type": "string",
          "description": "Template for the nudge comment. Supports {{days}}, {{reviewers}}, {{title}}, {{author}} placeholders.",
          "default": "‚è∞ This PR has been waiting for review for {{days}} days. Reviewers: {{reviewers}}. Please take a look!"
        },
        "dryRun": {
          "type": "boolean",
          "description": "When true, log nudge actions without actually posting comments. Defaults to false.",
          "default": false
        },
        "historyFile": {
          "type": "string",
          "description": "Path to the nudge history JSON file for cooldown tracking. Defaults to .pr-nudge-history.json.",
          "default": ".pr-nudge-history.json"
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "Configuration for PR dependency tracking. Detects relationships between open PRs based on branches, file overlap, or mentions.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether to enable dependency detection. Defaults to false.",
          "default": false
        },
        "strategies": {
          "type": "array",
          "description": "Which detection strategies to use.",
          "items": {
            "type": "string",
            "enum": ["branch", "fileOverlap", "mention"]
          },
          "default": ["branch", "mention"]
        },
        "fileOverlapThreshold": {
          "type": "integer",
          "description": "Minimum number of shared changed files to consider PRs dependent. Defaults to 2.",
          "default": 2,
          "minimum": 1
        },
        "mentionPattern": {
          "type": "string",
          "description": "Regex pattern to detect PR dependency mentions in title/description. Defaults to matching 'depends on #123' patterns.",
          "default": "depends on.*#(\\d+)"
        }
      }
    },
    "dora": {
      "type": "object",
      "description": "Configuration for DORA metrics (Change Lead Time, Deployment Frequency, Change Failure Rate, Mean Time to Restore).",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether to compute and display DORA metrics. Defaults to false.",
          "default": false
        },
        "periodDays": {
          "type": "integer",
          "description": "Number of days to look back for DORA metric computation. Defaults to 30.",
          "default": 30,
          "minimum": 7
        },
        "buildDefinitionIds": {
          "type": "array",
          "description": "Specific build definition IDs to include. If omitted, all builds are included.",
          "items": {
            "type": "integer"
          }
        },
        "historyFile": {
          "type": "string",
          "description": "Path to the DORA history JSON file for trend tracking. Defaults to .dora-history.json.",
          "default": ".dora-history.json"
        }
      }
    }
  }
}
